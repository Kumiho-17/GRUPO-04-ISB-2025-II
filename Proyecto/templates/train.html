{% extends "layout.html" %}
{% block content %}
<section class="card">
  <div class="card-header">
    <div>
      <div class="section-label">Entrenamiento guiado</div>
      <h2>PrÃ¡ctica de gestos con biofeedback</h2>
    </div>
  </div>

  <div class="content-grid">
    <!-- Columna izquierda: formulario -->
    <div>
      <form method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <label for="patient_name">Nombre del paciente</label>
          <input type="text" id="patient_name" name="patient_name"
                 class="text-input"
                 placeholder="Ej. Juan PÃ©rez"
                 value="{{ patient or '' }}">
          <div class="small-hint">
            El desempeÃ±o se registrarÃ¡ para este paciente.
          </div>
        </div>

        <div class="form-group">
          <label>Modelo de clasificaciÃ³n</label>
          <p class="small-hint" style="margin-top:4px;">
            Se utiliza de forma fija la
            <strong>CNN mejorada â€“ Ventanas crudas (400Ã—10, capa latente 64-D)</strong>,
            seleccionada como el modelo mÃ¡s consistente en la etapa de validaciÃ³n.
          </p>
          <input type="hidden" name="model" value="cnn_mejorada">
        </div>

        <div class="form-group">
          <label for="target_gesture">Gesto objetivo</label>
          <select id="target_gesture" name="target_gesture" class="gesture-select" required>
            <option value="">Selecciona un gesto para entrenar</option>
            {% for idx, name in gesture_labels.items() %}
              <option value="{{ idx }}"
                {% if result and result.target_gesture_idx is not none and result.target_gesture_idx == idx %}selected{% endif %}>
                Clase {{ idx }} â€“ {{ name }}
              </option>
            {% endfor %}
          </select>
          <div class="small-hint">
            El sistema asumirÃ¡ que el paciente intenta realizar este gesto y evaluarÃ¡ si lo logra.
          </div>
        </div>

        <!-- NUEVO: archivo EMG -->
        <div class="form-group">
          <label for="emg_file">SeÃ±al EMG para este intento (.npy, formato NÃ—10)</label>
          <input
            type="file"
            id="emg_file"
            name="emg_file"
            class="file-input"
            accept=".npy"
          />
          <div class="small-hint">
            Si no subes archivo, el sistema usarÃ¡ una seÃ±al EMG simulada solo con fines de demostraciÃ³n.
          </div>
        </div>

        <button type="submit" class="btn-primary">
          <span class="icon">ğŸ¯</span>
          Evaluar intento
        </button>
      </form>
    </div>

    <!-- Columna derecha: feedback -->
    <div>
      <div class="result-title">Biofeedback del intento</div>

      {% if result %}
        <div class="result-row">
          <span class="label">Paciente:</span> {{ result.patient }}
        </div>
        <div class="result-row">
          <span class="label">Modelo:</span>
          CNN mejorada â€“ Ventanas crudas (400Ã—10, capa latente 64-D)
        </div>
        <div class="result-row">
          <span class="label">Gesto objetivo:</span>
          Clase {{ result.target_gesture_idx }} â€“
          {{ result.target_gesture_name }}
        </div>
        <div class="result-row">
          <span class="label">Gesto detectado:</span>
          Clase {{ result.gesture_idx }} â€“
          <strong>{{ result.gesture_name }}</strong>
        </div>

        <div class="gesture-visual">
          <div class="gesture-icon
            {% if result.confidence_level == 'high' %}gv-high{% elif result.confidence_level == 'medium' %}gv-medium{% else %}gv-low{% endif %}
            hand-gesture-{{ result.gesture_idx }}">
            {% if result.gesture_idx == 0 %}ğŸ¾
            {% elif result.gesture_idx == 1 %}ğŸ¤
            {% elif result.gesture_idx == 2 %}âœ‹
            {% else %}âœŠ{% endif %}
          </div>
          <div class="gesture-quality-text">
            {{ result.feedback_text }}
          </div>
        </div>

        <div class="confidence-bar-wrapper">
          <div class="confidence-bar-bg">
            <div class="confidence-bar-fill
              {% if result.confidence_level == 'high' %}fill-high{% elif result.confidence_level == 'medium' %}fill-medium{% else %}fill-low{% endif %}"
              style="width: {{ result.confidence_pct }}%;"></div>
          </div>
          <div class="confidence-text">
            <span>Confianza del modelo</span>
            <span>
              {{ result.confidence_pct }}%
              {% if result.confidence_level == 'high' %}
                <span class="badge-confidence badge-high">Alta</span>
              {% elif result.confidence_level == 'medium' %}
                <span class="badge-confidence badge-medium">Media</span>
              {% else %}
                <span class="badge-confidence badge-low">Baja</span>
              {% endif %}
            </span>
          </div>
        </div>

        <div class="small-hint" style="margin-top:8px;">
          SesiÃ³n de entrenamiento de este paciente:
          <strong>{{ result.session_attempts }}</strong> intentos,
          <strong>{{ result.session_success }}</strong> aciertos
          ({{ result.session_success_pct }}%).
        </div>
      {% else %}
        <p class="muted">
          Ingresa un paciente, selecciona un gesto objetivo y pulsa
          <strong>â€œEvaluar intentoâ€</strong> para iniciar el entrenamiento guiado.
        </p>
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}